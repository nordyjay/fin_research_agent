{% extends 'base.html' %}

{% block title %}Research Chat - Financial Research Intelligence{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% load static %}{% static 'css/chat.css' %}">
{% endblock %}

{% block sidebar %}
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar -->
    <aside class="chat-sidebar" id="chatSidebar">
        <div class="sidebar-header">
            <button onclick="newChat()" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                <span>New Conversation</span>
            </button>
        </div>
        
        <div class="sidebar-content">
            <div class="conversations-list" id="conversationsList">
                <!-- Conversations will be loaded here -->
            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <div class="chat-main">
        <!-- Chat Messages -->
        <div id="chatMessages" class="chat-messages">
        <div class="chat-messages-inner">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h1 class="welcome-title">Financial Research Assistant</h1>
                    <p class="welcome-subtitle">Ask questions about broker research reports, price targets, and analyst recommendations</p>
                    
                    <div class="quick-actions">
                        <button onclick="sendSampleQuery('What are the latest price targets for NVDA?')" class="quick-action-card">
                            <div class="quick-action-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="quick-action-content">
                                <h3>Price Targets</h3>
                                <p>What are the latest price targets for NVDA?</p>
                            </div>
                        </button>
                        
                        <button onclick="sendSampleQuery('Compare revenue projections across brokers for AAPL')" class="quick-action-card">
                            <div class="quick-action-icon">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                            <div class="quick-action-content">
                                <h3>Broker Comparison</h3>
                                <p>Compare revenue projections across brokers</p>
                            </div>
                        </button>
                        
                        <button onclick="sendSampleQuery('What are the key risks for tech stocks?')" class="quick-action-card">
                            <div class="quick-action-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="quick-action-content">
                                <h3>Risk Analysis</h3>
                                <p>What are the key risks mentioned?</p>
                            </div>
                        </button>
                        
                        <button onclick="sendSampleQuery('Show me recent rating changes')" class="quick-action-card">
                            <div class="quick-action-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="quick-action-content">
                                <h3>Rating Changes</h3>
                                <p>Show me rating changes over time</p>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Input Area -->
    <div class="chat-input-area">
        <div class="chat-input-container">
            <form id="chatForm" class="chat-form">
                <div class="chat-input-wrapper">
                    <input type="text" 
                           id="messageInput" 
                           placeholder="Ask about price targets, ratings, revenue projections..." 
                           class="chat-input"
                           autocomplete="off">
                    <button type="submit" 
                            id="sendButton"
                            class="chat-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
            <div class="chat-input-footer">
                {% if OPENAI_API_KEY and OPENAI_API_KEY != 'your-openai-api-key-here' %}
                    <span class="chat-status">
                        <i class="fas fa-circle status-indicator"></i>
                        AI Ready â€¢ Analyzing broker research from Goldman Sachs, UBS, Morgan Stanley, and more
                    </span>
                {% else %}
                    <span class="chat-status chat-status-error">
                        <i class="fas fa-exclamation-circle"></i>
                        OpenAI API key not configured - Please set OPENAI_API_KEY in .env file
                    </span>
                {% endif %}
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentConversationId = null;
let isLoading = false;

// Load conversations on page load
document.addEventListener('DOMContentLoaded', function() {
    loadConversations();
    document.getElementById('messageInput').focus();
});

// Handle form submission
document.getElementById('chatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (isLoading) return;
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    sendMessage(message);
    input.value = '';
});

// Send message function
async function sendMessage(message) {
    if (isLoading) return;
    
    isLoading = true;
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    sendButton.innerHTML = '<span class="spinner spinner-sm"></span>';
    
    // Hide welcome screen if visible
    const welcomeScreen = document.getElementById('welcomeScreen');
    if (welcomeScreen) {
        welcomeScreen.style.display = 'none';
    }
    
    // Add user message to chat
    addMessageToChat('user', message);
    
    // Add loading message
    const loadingId = addLoadingMessage();
    
    try {
        const response = await fetch('/chat/message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: message,
                conversation_id: currentConversationId
            })
        });
        
        const data = await response.json();
        
        // Remove loading message
        removeLoadingMessage(loadingId);
        
        if (data.success) {
            currentConversationId = data.conversation_id;
            
            // Add assistant response
            addMessageToChat('assistant', data.message, data.sources);
            
            // Reload conversations to show new/updated one
            loadConversations();
        } else {
            addErrorMessage('Failed to get response. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        removeLoadingMessage(loadingId);
        addErrorMessage('An error occurred. Please check your connection and try again.');
    } finally {
        isLoading = false;
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
    }
}

// Add message to chat
function addMessageToChat(role, content, sources = null) {
    const chatMessages = document.getElementById('chatMessages');
    const messagesInner = chatMessages.querySelector('.chat-messages-inner');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message chat-message-${role}`;
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    
    const messageWrapper = document.createElement('div');
    messageWrapper.className = 'message-wrapper';
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = role === 'user' 
        ? '<i class="fas fa-user"></i>' 
        : '<i class="fas fa-robot"></i>';
    
    const messageBody = document.createElement('div');
    messageBody.className = 'message-body';
    
    const messageText = document.createElement('div');
    messageText.className = 'message-text';
    messageText.innerHTML = formatMessage(content);
    
    messageBody.appendChild(messageText);
    
    // Add sources if available
    if (sources && sources.length > 0) {
        const sourcesDiv = createSourcesDisplay(sources);
        messageBody.appendChild(sourcesDiv);
    }
    
    messageWrapper.appendChild(avatar);
    messageWrapper.appendChild(messageBody);
    messageContent.appendChild(messageWrapper);
    messageDiv.appendChild(messageContent);
    
    messagesInner.appendChild(messageDiv);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Format message content
function formatMessage(content) {
    // Convert markdown-style formatting
    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
    content = content.replace(/\n/g, '<br>');
    
    // Format tables if present
    if (content.includes('|')) {
        content = formatTables(content);
    }
    
    return content;
}

// Format tables
function formatTables(content) {
    const lines = content.split('<br>');
    let inTable = false;
    let tableHtml = '';
    let processedContent = '';
    
    for (const line of lines) {
        if (line.includes('|') && line.trim().startsWith('|')) {
            if (!inTable) {
                inTable = true;
                tableHtml = '<div class="message-table-wrapper"><table class="message-table">';
            }
            
            const cells = line.split('|').filter(cell => cell.trim());
            const isHeader = cells.some(cell => cell.trim().match(/^-+$/));
            
            if (!isHeader) {
                tableHtml += '<tr>';
                cells.forEach(cell => {
                    tableHtml += `<td>${cell.trim()}</td>`;
                });
                tableHtml += '</tr>';
            }
        } else {
            if (inTable) {
                inTable = false;
                tableHtml += '</table></div>';
                processedContent += tableHtml;
                tableHtml = '';
            }
            processedContent += line + '<br>';
        }
    }
    
    if (inTable) {
        tableHtml += '</table></div>';
        processedContent += tableHtml;
    }
    
    return processedContent;
}

// Create sources display
function createSourcesDisplay(sources) {
    const sourcesDiv = document.createElement('div');
    sourcesDiv.className = 'message-sources';
    
    const sourcesHeader = document.createElement('div');
    sourcesHeader.className = 'sources-header';
    sourcesHeader.innerHTML = '<i class="fas fa-book"></i> Sources';
    sourcesDiv.appendChild(sourcesHeader);
    
    const sourcesList = document.createElement('div');
    sourcesList.className = 'sources-list';
    
    sources.forEach((source, index) => {
        const sourceItem = document.createElement('div');
        sourceItem.className = 'source-item';
        sourceItem.onclick = () => showSourceModal(source);
        
        const sourceInfo = document.createElement('div');
        sourceInfo.className = 'source-info';
        sourceInfo.innerHTML = `
            <span class="source-broker">${source.broker || 'Unknown'}</span>
            <span class="source-ticker">${source.ticker || ''}</span>
            ${source.page_number ? `<span class="source-page">Page ${source.page_number}</span>` : ''}
        `;
        
        const sourcePreview = document.createElement('div');
        sourcePreview.className = 'source-preview';
        sourcePreview.textContent = source.text_preview || '';
        
        sourceItem.appendChild(sourceInfo);
        sourceItem.appendChild(sourcePreview);
        sourcesList.appendChild(sourceItem);
    });
    
    sourcesDiv.appendChild(sourcesList);
    return sourcesDiv;
}

// Show source modal
function showSourceModal(source) {
    console.log('Opening source modal with:', source);
    console.log('Source metadata:', source.metadata);
    console.log('Document ID at top level:', source.document_id);
    console.log('Document ID in metadata:', source.metadata ? source.metadata.document_id : 'No metadata');
    
    // Create modal if it doesn't exist
    let modal = document.getElementById('sourceModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'sourceModal';
        modal.className = 'source-modal';
        modal.innerHTML = `
            <div class="source-modal-content">
                <div class="source-modal-header">
                    <h2 class="source-modal-title">
                        <i class="fas fa-file-pdf"></i>
                        <span id="modalTitle">Document Source</span>
                    </h2>
                    <button class="source-modal-close" onclick="closeSourceModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="source-modal-body">
                    <div class="source-modal-metadata" id="modalMetadata"></div>
                    <div class="source-modal-actions" id="modalActions"></div>
                    <div class="source-modal-text" id="modalText"></div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeSourceModal();
            }
        });
    }
    
    // Update modal content
    document.getElementById('modalTitle').textContent = `${source.broker || 'Document'} - ${source.ticker || 'Research'}`;
    
    const metadata = document.getElementById('modalMetadata');
    metadata.innerHTML = `
        ${source.broker ? `
            <div class="source-modal-metadata-item">
                <span class="source-modal-metadata-label">Broker</span>
                <span class="source-modal-metadata-value">${source.broker}</span>
            </div>
        ` : ''}
        ${source.ticker ? `
            <div class="source-modal-metadata-item">
                <span class="source-modal-metadata-label">Ticker</span>
                <span class="source-modal-metadata-value">${source.ticker}</span>
            </div>
        ` : ''}
        ${source.page_number ? `
            <div class="source-modal-metadata-item">
                <span class="source-modal-metadata-label">Page Number</span>
                <span class="source-modal-metadata-value">${source.page_number}</span>
            </div>
        ` : ''}
        ${source.chunk_id ? `
            <div class="source-modal-metadata-item">
                <span class="source-modal-metadata-label">Chunk ID</span>
                <span class="source-modal-metadata-value">${source.chunk_id}</span>
            </div>
        ` : ''}
    `;
    
    // Add action buttons if document ID is available
    const actionsDiv = document.getElementById('modalActions');
    // Check for document_id in multiple places
    const docId = source.document_id || (source.metadata && source.metadata.document_id);
    
    if (docId) {
        actionsDiv.innerHTML = `
            <div class="source-action-buttons">
                <a href="/documents/view/${docId}/" 
                   class="btn btn-primary btn-sm" 
                   target="_blank">
                    <i class="fas fa-eye"></i>
                    View Original PDF
                </a>
                <a href="/documents/download/${docId}/" 
                   class="btn btn-secondary btn-sm">
                    <i class="fas fa-download"></i>
                    Download PDF
                </a>
            </div>
        `;
    } else {
        actionsDiv.innerHTML = '<p class="text-muted">Document reference not available - this document may need to be re-processed.</p>';
    }
    
    document.getElementById('modalText').textContent = source.full_text || source.text || source.text_preview || 'No content available';
    
    // Show modal
    modal.classList.add('active');
}

// Close source modal
function closeSourceModal() {
    const modal = document.getElementById('sourceModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// Add loading message
function addLoadingMessage() {
    const loadingId = 'loading-' + Date.now();
    const chatMessages = document.getElementById('chatMessages');
    const messagesInner = chatMessages.querySelector('.chat-messages-inner');
    
    const loadingDiv = document.createElement('div');
    loadingDiv.id = loadingId;
    loadingDiv.className = 'chat-message chat-message-assistant';
    loadingDiv.innerHTML = `
        <div class="message-content">
            <div class="message-wrapper">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-body">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    messagesInner.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return loadingId;
}

// Remove loading message
function removeLoadingMessage(loadingId) {
    const loadingDiv = document.getElementById(loadingId);
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

// Add error message
function addErrorMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const messagesInner = chatMessages.querySelector('.chat-messages-inner');
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'chat-error';
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-circle"></i>
        <span>${message}</span>
    `;
    
    messagesInner.appendChild(errorDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Load conversations
async function loadConversations() {
    try {
        const response = await fetch('/chat/conversations/');
        const data = await response.json();
        
        const conversationsList = document.getElementById('conversationsList');
        conversationsList.innerHTML = '';
        
        if (data.conversations && data.conversations.length > 0) {
            data.conversations.forEach(conv => {
                const convDiv = document.createElement('button');
                convDiv.className = 'conversation-item';
                if (conv.id === currentConversationId) {
                    convDiv.classList.add('active');
                }
                
                convDiv.innerHTML = `
                    <div class="conversation-title">${conv.title}</div>
                    <div class="conversation-date">${formatDate(conv.updated_at)}</div>
                `;
                
                convDiv.onclick = () => loadConversation(conv.id);
                conversationsList.appendChild(convDiv);
            });
        } else {
            conversationsList.innerHTML = '<div class="no-conversations">No conversations yet</div>';
        }
    } catch (error) {
        console.error('Error loading conversations:', error);
    }
}

// Load specific conversation
async function loadConversation(conversationId) {
    try {
        const response = await fetch(`/chat/conversation/${conversationId}/messages/`);
        const data = await response.json();
        
        currentConversationId = conversationId;
        
        // Clear chat and hide welcome screen
        const chatMessages = document.getElementById('chatMessages');
        const messagesInner = chatMessages.querySelector('.chat-messages-inner');
        messagesInner.innerHTML = '';
        
        // Add messages
        if (data.messages) {
            data.messages.forEach(msg => {
                addMessageToChat(msg.role, msg.content, msg.metadata?.sources);
            });
        }
        
        // Update active conversation
        loadConversations();
    } catch (error) {
        console.error('Error loading conversation:', error);
    }
}

// New chat
function newChat() {
    currentConversationId = null;
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = `
        <div class="chat-messages-inner">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h1 class="welcome-title">Financial Research Assistant</h1>
                    <p class="welcome-subtitle">Ask questions about broker research reports, price targets, and analyst recommendations</p>
                    
                    <div class="quick-actions">
                        <button onclick="sendSampleQuery('What are the latest price targets for NVDA?')" class="quick-action-card">
                            <div class="quick-action-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="quick-action-content">
                                <h3>Price Targets</h3>
                                <p>What are the latest price targets for NVDA?</p>
                            </div>
                        </button>
                        
                        <button onclick="sendSampleQuery('Compare revenue projections across brokers for AAPL')" class="quick-action-card">
                            <div class="quick-action-icon">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                            <div class="quick-action-content">
                                <h3>Broker Comparison</h3>
                                <p>Compare revenue projections across brokers</p>
                            </div>
                        </button>
                        
                        <button onclick="sendSampleQuery('What are the key risks for tech stocks?')" class="quick-action-card">
                            <div class="quick-action-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="quick-action-content">
                                <h3>Risk Analysis</h3>
                                <p>What are the key risks mentioned?</p>
                            </div>
                        </button>
                        
                        <button onclick="sendSampleQuery('Show me recent rating changes')" class="quick-action-card">
                            <div class="quick-action-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="quick-action-content">
                                <h3>Rating Changes</h3>
                                <p>Show me rating changes over time</p>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    loadConversations();
    document.getElementById('messageInput').focus();
}

// Send sample query
function sendSampleQuery(query) {
    document.getElementById('messageInput').value = query;
    sendMessage(query);
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) return 'Today';
    if (days === 1) return 'Yesterday';
    if (days < 7) return `${days} days ago`;
    if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
    if (days < 365) return `${Math.floor(days / 30)} months ago`;
    return `${Math.floor(days / 365)} years ago`;
}

// Get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add keyboard shortcut for ESC to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSourceModal();
    }
});
</script>
{% endblock %}