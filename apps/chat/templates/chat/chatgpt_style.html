{% extends 'base.html' %}

{% block title %}Research Chat - Broker Analysis{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50" style="height: calc(100vh - 64px);">
    <!-- Sidebar -->
    <div class="w-64 bg-gray-900 text-white p-4 overflow-y-auto">
        <button onclick="newChat()" class="w-full bg-gray-700 hover:bg-gray-600 rounded-lg px-4 py-3 mb-4 text-left flex items-center justify-center space-x-2 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span>New chat</span>
        </button>
        
        <div class="space-y-2" id="conversationsList">
            <!-- Conversations will be loaded here -->
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Chat Messages -->
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
            <div class="max-w-3xl mx-auto">
                <div class="text-center py-20 text-gray-500">
                    <h1 class="text-3xl font-bold text-gray-900 mb-4">Broker Research Assistant</h1>
                    <p class="mb-8">Ask questions about broker research reports, price targets, and analyst recommendations</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                        <button onclick="sendSampleQuery('What are the latest price targets for NVDA?')" class="bg-white border border-gray-300 rounded-lg p-4 text-left hover:bg-gray-50 transition-colors">
                            <div class="font-medium text-gray-900 mb-1">üìä Price Targets</div>
                            <div class="text-sm text-gray-600">What are the latest price targets for NVDA?</div>
                        </button>
                        <button onclick="sendSampleQuery('Compare revenue projections across brokers')" class="bg-white border border-gray-300 rounded-lg p-4 text-left hover:bg-gray-50 transition-colors">
                            <div class="font-medium text-gray-900 mb-1">üìà Revenue Analysis</div>
                            <div class="text-sm text-gray-600">Compare revenue projections across brokers</div>
                        </button>
                        <button onclick="sendSampleQuery('What are the key risks mentioned?')" class="bg-white border border-gray-300 rounded-lg p-4 text-left hover:bg-gray-50 transition-colors">
                            <div class="font-medium text-gray-900 mb-1">‚ö†Ô∏è Risk Assessment</div>
                            <div class="text-sm text-gray-600">What are the key risks mentioned?</div>
                        </button>
                        <button onclick="sendSampleQuery('Show me rating changes over time')" class="bg-white border border-gray-300 rounded-lg p-4 text-left hover:bg-gray-50 transition-colors">
                            <div class="font-medium text-gray-900 mb-1">‚≠ê Ratings</div>
                            <div class="text-sm text-gray-600">Show me rating changes over time</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="border-t border-gray-200 bg-white p-4">
            <div class="max-w-3xl mx-auto">
                <form id="chatForm" class="flex gap-3">
                    <input type="text" 
                           id="messageInput" 
                           placeholder="Ask about price targets, ratings, revenue projections..." 
                           class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           autocomplete="off">
                    <button type="submit" 
                            id="sendButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        Send
                    </button>
                </form>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    {% if OPENAI_API_KEY and OPENAI_API_KEY != 'your-openai-api-key-here' %}
                        Powered by GPT-4 ‚Ä¢ Analyzing broker research from UBS, Barclays, and more
                    {% else %}
                        <span class="text-red-600">‚ö†Ô∏è OpenAI API key not configured - Please set OPENAI_API_KEY in .env file</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversationId = null;
let isLoading = false;

// Load conversations on page load
document.addEventListener('DOMContentLoaded', function() {
    loadConversations();
    document.getElementById('messageInput').focus();
});

// Handle form submission
document.getElementById('chatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (isLoading) return;
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    sendMessage(message);
    input.value = '';
});

async function sendMessage(message) {
    if (isLoading) return;
    
    isLoading = true;
    updateButtonState(true);
    
    // Add user message to UI
    addMessage('user', message);
    
    // Add loading message
    const loadingId = addMessage('assistant', '', true);
    
    try {
        const response = await fetch('{% url "chat:message" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                conversation_id: currentConversationId,
                message: message
            })
        });
        
        const data = await response.json();
        
        // Remove loading message
        document.getElementById(loadingId)?.remove();
        
        if (data.success) {
            currentConversationId = data.conversation_id;
            
            // Add assistant response
            addMessage('assistant', data.message, false, data.sources);
            
            // Reload conversations list
            loadConversations();
        } else {
            addMessage('assistant', `Error: ${data.error || 'Unknown error occurred'}`);
        }
    } catch (error) {
        document.getElementById(loadingId)?.remove();
        addMessage('assistant', `Error: ${error.message}`);
    } finally {
        isLoading = false;
        updateButtonState(false);
    }
}

function addMessage(role, content, isLoading = false, sources = null) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageId = 'msg-' + Date.now();
    
    // Remove welcome message if exists
    const welcome = messagesDiv.querySelector('.text-center.py-20');
    if (welcome) welcome.remove();
    
    const messageDiv = document.createElement('div');
    messageDiv.id = messageId;
    messageDiv.className = 'message-animate';
    
    const bgColor = role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100';
    
    let messageContent = '';
    if (isLoading) {
        messageContent = `
            <div class="flex space-x-2">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        `;
    } else {
        messageContent = `<p class="whitespace-pre-wrap">${escapeHtml(content)}</p>`;
        
        // Add sources if available
        if (sources && sources.length > 0) {
            messageContent += `
                <div class="mt-4 pt-4 border-t border-gray-300">
                    <p class="text-sm font-semibold text-gray-800 mb-3">üìÑ Sources Referenced:</p>
                    <div class="grid grid-cols-1 gap-2">
                        ${sources.map((s, idx) => {
                            // Store source data in a data attribute instead of inline onclick
                            const sourceId = `source-${Date.now()}-${idx}`;
                            // Store the source data globally
                            window[sourceId] = s;
                            
                            return `
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors cursor-pointer"
                                 onclick="showSourceDetailById('${sourceId}')">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                ${idx + 1}
                                            </span>
                                            <span class="font-medium text-sm">${escapeHtml(s.broker || 'Unknown')}</span>
                                            ${s.ticker ? `<span class="text-sm text-gray-600">‚Ä¢ ${escapeHtml(s.ticker)}</span>` : ''}
                                        </div>
                                        <div class="text-xs text-gray-600 mt-1">
                                            ${s.content_type ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                                s.content_type === 'image' ? 'bg-purple-100 text-purple-800' :
                                                s.content_type === 'table' ? 'bg-green-100 text-green-800' :
                                                'bg-gray-100 text-gray-800'
                                            }">${s.content_type}</span>` : ''}
                                            ${s.report_date ? `<span class="ml-2">${s.report_date}</span>` : ''}
                                            ${s.page_number ? `<span class="ml-2">Page ${s.page_number}</span>` : ''}
                                            ${s.score ? `<span class="ml-2 text-gray-500">Score: ${s.score.toFixed(3)}</span>` : ''}
                                        </div>
                                        ${s.text_preview ? `
                                            <div class="mt-2 text-xs text-gray-700 line-clamp-2">
                                                "${escapeHtml(s.text_preview)}"
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }
    }
    
    messageDiv.innerHTML = `
        <div class="max-w-3xl mx-auto">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full ${role === 'user' ? 'bg-blue-600' : 'bg-gray-600'} flex items-center justify-center">
                    ${role === 'user' ? 
                        '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>' : 
                        '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path></svg>'
                    }
                </div>
                <div class="flex-1">
                    <div class="text-sm font-medium text-gray-900 mb-1">${role === 'user' ? 'You' : 'Assistant'}</div>
                    <div class="${role === 'user' ? '' : 'prose prose-sm max-w-none'}">
                        ${messageContent}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    return messageId;
}

async function loadConversations() {
    try {
        const response = await fetch('{% url "chat:conversations" %}');
        const data = await response.json();
        
        const listDiv = document.getElementById('conversationsList');
        listDiv.innerHTML = data.conversations.map(conv => `
            <button onclick="loadConversation('${conv.id}')" 
                    class="w-full text-left px-3 py-2 rounded hover:bg-gray-800 transition-colors ${conv.id === currentConversationId ? 'bg-gray-800' : ''}">
                <div class="text-sm font-medium truncate">${escapeHtml(conv.title)}</div>
                <div class="text-xs text-gray-400">${formatDate(conv.updated_at)}</div>
            </button>
        `).join('');
    } catch (error) {
        console.error('Error loading conversations:', error);
    }
}

async function loadConversation(conversationId) {
    try {
        const response = await fetch(`/chat/conversation/${conversationId}/messages/`);
        const data = await response.json();
        
        if (data.success) {
            currentConversationId = conversationId;
            
            // Clear chat
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';
            
            // Add messages
            data.messages.forEach(msg => {
                addMessage(msg.role, msg.content, false, msg.metadata?.sources);
            });
            
            // Update active conversation in sidebar
            loadConversations();
        }
    } catch (error) {
        console.error('Error loading conversation:', error);
    }
}

function newChat() {
    currentConversationId = null;
    document.getElementById('chatMessages').innerHTML = `
        <div class="max-w-3xl mx-auto">
            <div class="text-center py-20 text-gray-500">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">Broker Research Assistant</h1>
                <p class="mb-8">Start a new conversation about broker research reports</p>
            </div>
        </div>
    `;
    document.getElementById('messageInput').focus();
}

function sendSampleQuery(query) {
    document.getElementById('messageInput').value = query;
    sendMessage(query);
}

function updateButtonState(loading) {
    const button = document.getElementById('sendButton');
    const input = document.getElementById('messageInput');
    
    button.disabled = loading;
    input.disabled = loading;
    
    if (loading) {
        button.innerHTML = `
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        `;
    } else {
        button.innerHTML = 'Send';
        input.focus();
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
}
// Modal HTML
const artifactModal = `
<div id="artifactModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-75" onclick="closeArtifactModal()"></div>
    <div class="absolute inset-4 md:inset-8 bg-white rounded-lg shadow-2xl flex flex-col">
        <div class="flex items-center justify-between p-4 border-b">
            <h3 id="artifactTitle" class="text-lg font-semibold"></h3>
            <button onclick="closeArtifactModal()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="artifactContent" class="flex-1 overflow-auto p-4">
            <div class="flex items-center justify-center h-full">
                <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
        <div class="flex items-center justify-between p-4 border-t">
            <div id="artifactMetadata" class="text-sm text-gray-600"></div>
            <div class="flex gap-2">
                <button id="prevArtifact" onclick="navigateArtifact(-1)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50">
                    Previous
                </button>
                <button id="nextArtifact" onclick="navigateArtifact(1)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50">
                    Next
                </button>
            </div>
        </div>
    </div>
</div>
`;

// Add modal to page
document.body.insertAdjacentHTML('beforeend', artifactModal);

let currentSources = [];
let currentSourceIndex = 0;

// Function to show artifact details by ID
function showSourceDetailById(sourceId) {
    try {
        const source = window[sourceId];
        if (!source) {
            throw new Error('Source data not found');
        }
        
        // Find this source in the current sources array
        currentSourceIndex = currentSources.findIndex(s => 
            s.node_id === source.node_id || 
            (s.broker === source.broker && s.page_number === source.page_number && s.content_type === source.content_type)
        );
        if (currentSourceIndex === -1) {
            currentSourceIndex = 0;
        }
        
        displayArtifact(source);
    } catch (error) {
        console.error('Error showing source detail:', error);
        alert('Error loading artifact: ' + error.message);
    }
}

// Legacy function for backward compatibility
async function showSourceDetail(sourceJson) {
    try {
        const source = JSON.parse(sourceJson);
        
        // Find this source in the current sources array
        currentSourceIndex = currentSources.findIndex(s => s.node_id === source.node_id);
        if (currentSourceIndex === -1) {
            currentSourceIndex = 0;
        }
        
        await displayArtifact(source);
    } catch (error) {
        console.error('Error showing source detail:', error);
        alert('Error loading artifact: ' + error.message);
    }
}

async function displayArtifact(source) {
    const modal = document.getElementById('artifactModal');
    const title = document.getElementById('artifactTitle');
    const content = document.getElementById('artifactContent');
    const metadata = document.getElementById('artifactMetadata');
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Set title
    title.textContent = `${source.broker} - ${source.ticker || 'N/A'} (${source.content_type})`;
    
    // Set metadata
    metadata.textContent = `Page ${source.page_number || 'N/A'} ‚Ä¢ ${source.report_date || 'N/A'}`;
    
    try {
        // Check if we have the content embedded in the source
        if (source.full_text && source.content_type !== 'image') {
            // We have the content, display it directly without fetching
            if (source.content_type === 'table') {
                // For tables, check if we have a valid summary, otherwise show the preview
                const text = source.full_text || '';
                let displayContent = '';
                
                // Check if this is a processed table with a REAL summary (not the error message)
                const summaryMatch = text.match(/TABLE SUMMARY:\s*(.+?)(?=RAW TABLE DATA:|$)/s);
                const summary = summaryMatch ? summaryMatch[1].trim() : '';
                
                // Check if it's a real summary or the generic error message
                if (summary && !summary.includes('It seems that the financial table') && !summary.includes('missing')) {
                    // We have a real summary
                    displayContent = `
                        <div class="space-y-4">
                            <div class="p-6 bg-blue-50 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <svg class="w-6 h-6 text-blue-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900 mb-2">Table Summary</h4>
                                        <p class="text-gray-700 leading-relaxed">${escapeHtml(summary)}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // No valid summary, show the text preview instead
                    const preview = source.text_preview || source.full_text || 'Table data';
                    displayContent = `
                        <div class="p-6 bg-gray-50 rounded-lg">
                            <div class="flex items-start space-x-3">
                                <svg class="w-6 h-6 text-gray-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 mb-3">Table Content</h4>
                                    <div class="text-sm text-gray-700 font-mono whitespace-pre-wrap bg-white p-4 rounded border border-gray-200">
${escapeHtml(preview)}
                                    </div>
                                    <p class="text-xs text-gray-500 mt-3 text-center">Full table rendering is being improved</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = `<div class="max-w-2xl mx-auto">${displayContent}</div>`;
            } else {
                // Text content - format it better
                const text = source.full_text;
                let formattedContent = '';
                
                // Check if it's structured content with clear sections
                const lines = text.split('\n');
                const formattedLines = [];
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine) {
                        // Detect headers (lines that are all caps or end with colon)
                        if (trimmedLine.match(/^[A-Z\s]+:?$/) || trimmedLine.endsWith(':')) {
                            formattedLines.push(`<strong>${escapeHtml(trimmedLine)}</strong>`);
                        } else {
                            formattedLines.push(escapeHtml(line));
                        }
                    } else {
                        formattedLines.push('');
                    }
                }
                
                content.innerHTML = `
                    <div class="prose max-w-none">
                        <div class="text-sm leading-relaxed whitespace-pre-wrap font-mono bg-gray-50 p-6 rounded-lg overflow-auto">
${formattedLines.join('\n')}
                        </div>
                    </div>
                `;
            }
        } else if (source.content_type === 'image' && source.image_path) {
            // For images, we need to use the image path from the server
            content.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <img src="${source.image_path}" 
                         alt="${source.broker} - ${source.ticker}" 
                         class="max-w-full max-h-full object-contain cursor-zoom-in"
                         onclick="toggleImageZoom(this)"
                         onerror="this.onerror=null; this.src='/static/placeholder.png'; this.alt='Image not found'">
                </div>
            `;
        } else {
            // Fallback: show what we have
            content.innerHTML = `
                <div class="prose max-w-none">
                    <p class="text-sm text-gray-600 mb-2">
                        Content type: ${source.content_type}<br>
                        Source: ${source.broker} - ${source.ticker}
                    </p>
                    <pre class="whitespace-pre-wrap bg-gray-50 p-4 rounded">${escapeHtml(source.text_preview || 'No preview available')}</pre>
                </div>
            `;
        }
        
        // Update navigation buttons
        updateNavigationButtons();
        
    } catch (error) {
        content.innerHTML = `
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Error loading artifact</h3>
                    <p class="mt-1 text-sm text-gray-500">${error.message}</p>
                </div>
            </div>
        `;
    }
}

function closeArtifactModal() {
    document.getElementById('artifactModal').classList.add('hidden');
}

function toggleImageZoom(img) {
    img.classList.toggle('cursor-zoom-out');
    img.classList.toggle('cursor-zoom-in');
    img.classList.toggle('max-w-full');
    img.classList.toggle('w-auto');
}

function convertMarkdownTableToHtml(markdownTable) {
    const lines = markdownTable.split('\n').filter(line => line.trim() && line.includes('|'));
    if (lines.length < 2) return '<p>Invalid table format</p>';
    
    // Find separator line (contains dashes)
    let separatorIndex = -1;
    for (let i = 0; i < lines.length; i++) {
        if (lines[i].includes('---') || lines[i].includes('‚Äî')) {
            separatorIndex = i;
            break;
        }
    }
    
    // If no separator found, assume first line is header
    const headerIndex = separatorIndex > 0 ? separatorIndex - 1 : 0;
    const dataStartIndex = separatorIndex >= 0 ? separatorIndex + 1 : 1;
    
    let html = '<table class="min-w-full divide-y divide-gray-200 text-sm">';
    
    // Process header
    if (headerIndex >= 0 && headerIndex < lines.length) {
        const headers = lines[headerIndex].split('|').map(cell => cell.trim()).filter(cell => cell !== '');
        html += '<thead class="bg-gray-50"><tr>';
        headers.forEach(header => {
            html += `<th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">${escapeHtml(header)}</th>`;
        });
        html += '</tr></thead>';
    }
    
    // Process body
    html += '<tbody class="bg-white divide-y divide-gray-200">';
    for (let i = dataStartIndex; i < lines.length; i++) {
        if (lines[i].includes('---')) continue; // Skip any separator lines
        
        const cells = lines[i].split('|').map(cell => cell.trim());
        // Remove empty cells from start and end (markdown tables often have empty cells due to leading/trailing |)
        while (cells.length > 0 && cells[0] === '') cells.shift();
        while (cells.length > 0 && cells[cells.length - 1] === '') cells.pop();
        
        if (cells.length > 0) {
            html += '<tr class="hover:bg-gray-50">';
            cells.forEach(cell => {
                // Remove excessive whitespace and make content more readable
                const cleanCell = cell.replace(/\s+/g, ' ').trim();
                html += `<td class="px-3 py-2 text-sm text-gray-900">${escapeHtml(cleanCell)}</td>`;
            });
            html += '</tr>';
        }
    }
    html += '</tbody></table>';
    
    return html;
}

function navigateArtifact(direction) {
    const newIndex = currentSourceIndex + direction;
    if (newIndex >= 0 && newIndex < currentSources.length) {
        currentSourceIndex = newIndex;
        displayArtifact(currentSources[newIndex]);
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevArtifact');
    const nextBtn = document.getElementById('nextArtifact');
    
    prevBtn.disabled = currentSourceIndex === 0;
    nextBtn.disabled = currentSourceIndex === currentSources.length - 1;
}

// Update the sources when a new message is received
const originalAddMessage = addMessage;
addMessage = function(role, content, isLoading = false, sources = null) {
    if (sources && sources.length > 0) {
        currentSources = sources;
    }
    return originalAddMessage(role, content, isLoading, sources);
};

// Add custom CSS for line-clamp
const style = document.createElement('style');
style.textContent = `
    .line-clamp-2 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}