{% extends 'base.html' %}

{% block title %}Document Library - Financial Research Intelligence{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% load static %}{% static 'css/upload.css' %}">
{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="container">
        <div class="page-header-content">
            <div>
                <h1 class="page-title">Document Library</h1>
                <p class="page-subtitle">Upload and manage broker research PDFs</p>
            </div>
            <div class="page-stats">
                <div class="stat-card">
                    <div class="stat-value">{{ documents|length }}</div>
                    <div class="stat-label">Total Documents</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container">
    <div class="upload-section">
        <!-- Upload Card -->
        <div class="card upload-card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload New Document
                </h2>
            </div>
            
            <form method="post" enctype="multipart/form-data" class="upload-form" id="uploadForm">
                {% csrf_token %}
                
                <!-- Drag and Drop Zone -->
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="pdf_file" accept=".pdf" required
                           class="drop-zone-input" id="pdfFileInput">
                    <div class="drop-zone-content">
                        <i class="fas fa-file-pdf drop-zone-icon"></i>
                        <p class="drop-zone-text">Drag and drop your PDF here or click to browse</p>
                        <p class="drop-zone-hint">Maximum file size: 50MB</p>
                    </div>
                    <div class="drop-zone-preview" id="filePreview"></div>
                </div>
                
                <!-- Optional Metadata -->
                <div class="metadata-section">
                    <button type="button" class="metadata-toggle" id="metadataToggle">
                        <i class="fas fa-chevron-right toggle-icon"></i>
                        <span>Advanced Options (Optional)</span>
                    </button>
                    
                    <div class="metadata-fields" id="metadataFields">
                        <p class="metadata-hint">
                            <i class="fas fa-info-circle"></i>
                            Leave blank for automatic extraction from PDF content
                        </p>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Broker Name</label>
                                <input type="text" name="broker" 
                                       placeholder="e.g., Goldman Sachs, UBS, Morgan Stanley"
                                       class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Ticker Symbol</label>
                                <input type="text" name="ticker" 
                                       placeholder="e.g., NVDA, AAPL, MSFT"
                                       class="form-input" style="text-transform: uppercase;">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Report Date</label>
                                <input type="date" name="report_date" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary btn-lg upload-btn" id="uploadButton">
                    <i class="fas fa-upload"></i>
                    <span id="uploadButtonText">Upload and Process</span>
                    <span class="spinner" id="uploadSpinner" style="display: none;"></span>
                </button>
            </form>
        </div>
        
        <!-- Documents List -->
        <div class="card mt-6">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-folder-open"></i>
                    Uploaded Documents
                </h2>
                <div class="card-actions">
                    <button class="btn btn-ghost btn-sm" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
            
            <div class="documents-list">
                {% for doc in documents %}
                <div class="document-item {% if doc.processed %}processed{% else %}processing{% endif %}">
                    <div class="document-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    
                    <div class="document-details">
                        <div class="document-header">
                            <h3 class="document-title">
                                {% if doc.broker %}{{ doc.broker }}{% else %}Unknown Broker{% endif %}
                                {% if doc.ticker %}- {{ doc.ticker }}{% endif %}
                            </h3>
                            {% if doc.processed %}
                                <span class="badge badge-success">
                                    <i class="fas fa-check-circle"></i>
                                    Processed
                                </span>
                            {% else %}
                                <span class="badge badge-warning">
                                    <span class="spinner spinner-sm"></span>
                                    Processing
                                </span>
                            {% endif %}
                        </div>
                        
                        <div class="document-meta">
                            {% if doc.report_date %}
                                <span><i class="fas fa-calendar-alt"></i> {{ doc.report_date }}</span>
                            {% endif %}
                            <span><i class="fas fa-clock"></i> {{ doc.created_at|date:"Y-m-d H:i" }}</span>
                            {% if doc.processed and doc.total_chunks %}
                                <span><i class="fas fa-cube"></i> {{ doc.total_chunks }} chunks</span>
                                {% if doc.total_tables > 0 %}
                                    <span><i class="fas fa-table"></i> {{ doc.total_tables }} tables</span>
                                {% endif %}
                                {% if doc.total_images > 0 %}
                                    <span><i class="fas fa-image"></i> {{ doc.total_images }} images</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        {% if doc.processing_error %}
                        <div class="document-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            {{ doc.processing_error }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="document-actions">
                        <a href="{% url 'documents:view' doc.id %}" 
                           class="btn btn-ghost btn-sm" 
                           title="View PDF"
                           target="_blank">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'documents:download' doc.id %}" 
                           class="btn btn-ghost btn-sm" 
                           title="Download PDF">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="fas fa-folder-open empty-state-icon"></i>
                    <h3 class="empty-state-title">No documents uploaded yet</h3>
                    <p class="empty-state-text">Upload your first broker research PDF to get started</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// File handling
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('pdfFileInput');
const filePreview = document.getElementById('filePreview');
const uploadForm = document.getElementById('uploadForm');
const metadataToggle = document.getElementById('metadataToggle');
const metadataFields = document.getElementById('metadataFields');

// Metadata toggle
metadataToggle.addEventListener('click', function() {
    metadataFields.classList.toggle('active');
    this.classList.toggle('active');
    const icon = this.querySelector('.toggle-icon');
    icon.classList.toggle('fa-chevron-right');
    icon.classList.toggle('fa-chevron-down');
});

// Drag and drop events
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    dropZone.classList.add('drag-over');
}

function unhighlight(e) {
    dropZone.classList.remove('drag-over');
}

// Drop files
dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

// Click to select - prevent double clicks and event bubbling
dropZone.addEventListener('click', (e) => {
    if (e.target.closest('.file-preview-remove')) {
        // Don't trigger file input if clicking the remove button
        return;
    }
    if (e.target.closest('.drop-zone-input')) {
        // Don't trigger again if clicking the input itself
        return;
    }
    e.stopPropagation();
    fileInput.click();
});

// File input change
fileInput.addEventListener('change', function(e) {
    console.log('File input changed:', this.files.length, 'files');
    if (this.files.length > 0) {
        console.log('File selected:', this.files[0].name, this.files[0].type);
    }
    handleFiles(this.files);
});

function handleFiles(files) {
    if (files.length === 0) {
        console.log('No files selected');
        return;
    }
    
    const file = files[0];
    console.log('Processing file:', file.name, 'Type:', file.type, 'Size:', file.size);
    
    // Validate file type - check both MIME type and extension
    const isPDF = file.type === 'application/pdf' || 
                  file.type === 'application/x-pdf' || 
                  file.name.toLowerCase().endsWith('.pdf');
    
    if (!isPDF) {
        console.error('Invalid file type:', file.type);
        showNotification('Please select a valid PDF file', 'error');
        fileInput.value = ''; // Clear the input
        return;
    }
    
    // Validate file size (50MB max)
    const maxSize = 50 * 1024 * 1024;
    if (file.size > maxSize) {
        showNotification('File size exceeds 50MB limit', 'error');
        return;
    }
    
    // Show preview
    showFilePreview(file);
}

function showFilePreview(file) {
    // Store file reference to prevent it from being cleared
    fileInput.dataset.hasFile = 'true';
    
    const fileSize = (file.size / 1024 / 1024).toFixed(2);
    filePreview.innerHTML = `
        <div class="file-preview-content">
            <i class="fas fa-file-pdf file-preview-icon"></i>
            <div class="file-preview-info">
                <div class="file-preview-name">${file.name}</div>
                <div class="file-preview-size">${fileSize} MB</div>
            </div>
            <button type="button" class="file-preview-remove" onclick="clearFileSelection()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    filePreview.style.display = 'block';
    dropZone.querySelector('.drop-zone-content').style.display = 'none';
}

function clearFileSelection() {
    fileInput.value = '';
    fileInput.dataset.hasFile = 'false';
    filePreview.innerHTML = '';
    filePreview.style.display = 'none';
    dropZone.querySelector('.drop-zone-content').style.display = 'flex';
}

// Form submission
uploadForm.addEventListener('submit', function(e) {
    const uploadButton = document.getElementById('uploadButton');
    const uploadButtonText = document.getElementById('uploadButtonText');
    const uploadSpinner = document.getElementById('uploadSpinner');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        e.preventDefault();
        showNotification('Please select a PDF file to upload', 'error');
        return;
    }
    
    // Disable button and show loading
    uploadButton.disabled = true;
    uploadButton.classList.add('loading');
    uploadButtonText.textContent = 'Processing...';
    uploadSpinner.style.display = 'inline-block';
    
    // Show progress notification
    showNotification('Uploading document...', 'info');
});

// Notifications
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <i class="fas fa-${getNotificationIcon(type)}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    // Trigger animation
    setTimeout(() => notification.classList.add('show'), 10);
    
    // Auto remove
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

function getNotificationIcon(type) {
    const icons = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

// Auto-refresh for processing documents
const processingDocs = document.querySelectorAll('.document-item.processing');
if (processingDocs.length > 0) {
    setTimeout(() => {
        location.reload();
    }, 10000);
}
</script>
{% endblock %}